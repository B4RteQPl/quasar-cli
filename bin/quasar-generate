#!/usr/bin/env node

var
  command = require('commander'),
  inquirer = require('inquirer'),
  glob = require('glob'),
  log = require('../lib/log'),
  qfs = require('../lib/qfs'),
  type,
  name,
  src

if (!qfs.is.inAppFolder()) {
  log.fatal('Not in an App folder.')
  // ^^^ EARLY EXIT
}

command
  .usage('<template> <name>')
  .on('--help', function () {
    log('  Templates are stored in ' + '/templates'.gray)
    log()
    log('  Example:')
    log()
    log('    # get available templates'.gray)
    log('    $ quasar generate list')
    log()
    log('    # generate .vue from a template'.gray)
    log('    $ quasar generate component Hello')
    log('    $ quasar generate page inbox')
    log('    $ quasar generate layout master-layout')
    log('    $ quasar generate customVue chat')
  })
  .parse(process.argv)

if (!command.args.length || command.args.length > 2) {
  command.help()
  process.exit(1)
  // ^^^ EARLY EXIT
}
else if (command.args.length === 1) {
  if (command.args[0] !== 'list') {
    command.help()
    process.exit(1)
    // ^^^ EARLY EXIT
  }

  log(' Available templates:'.gray)
  log()

  glob(qfs.get.root('templates', '*.vue'), function (err, files) {
    if (err) throw err
    files.forEach(function (file) {
      log('    ' + qfs.basename(file, '.vue'))
    })
  })
}
else {
  generate()
}

function generate () {
  type = command.args[0] + '.vue'
  name = command.args[1] + '.vue'
  src = qfs.get.root('templates', type)

  if (!qfs.exists(src)) {
    log.fatal('Template "' + (type + '.vue').gray + '" does not exists.')
    // ^^^ EARLY EXIT
  }

  var
    dest = qfs.get.root('src', 'components', name),
    relativeDest = qfs.relative(dest)

  if (qfs.exists(dest)) {
    log.fatal('There is already a file at ' + relativeDest.gray + '.')
    // ^^^ EARLY EXIT
  }

  if (qfs.copy(src, dest)) {
    log.fatal('Error while trying to generate ' + relativeDest.gray + '.')
    // ^^^ EARLY EXIT
  }

  log.success('Generated "' + name.gray + '" from "' + type.gray + '".')
}
